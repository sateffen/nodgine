<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>nodgine\Controller\Router.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/$APPLICATION.html">$APPLICATION</a></li>
            
                <li><a href="../classes/$LOGGER.html">$LOGGER</a></li>
            
                <li><a href="../classes/$ROUTER.html">$ROUTER</a></li>
            
                <li><a href="../classes/$SERVICE.html">$SERVICE</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/$APPLICATION.html">$APPLICATION</a></li>
            
                <li><a href="../modules/$LOGGER.html">$LOGGER</a></li>
            
                <li><a href="../modules/$ROUTER.html">$ROUTER</a></li>
            
                <li><a href="../modules/$SERVICE.html">$SERVICE</a></li>
            
                <li><a href="../modules/nodgine.html">nodgine</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: nodgine\Controller\Router.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * This is the Router API for the nodgine module
 *
 * @module nodgine
 * @submodule $ROUTER
 * @class $ROUTER
 * @static
 **/

/**
 * The exporting object, which gets revealed
 *
 * @type {object}
 **/
var EXPORTOBJECT = {},

    /**
     * A list of all routes
     *
     * @private
     * @type {Array}
     **/
    mRoutes = [],

    /**
     * A reference to the url-module
     *
     * @private
     * @type {url}
     **/
    mUrl = require(&#x27;url&#x27;),

    /**
     * A reference to the querystring-module
     *
     * @private
     * @type {querystring}
     **/
    mQuerystring = require(&#x27;querystring&#x27;),

    /**
     * The requestencoding
     *
     * @private
     * @type {string}
     * @default &#x27;utf-8&#x27;
     **/
    mRequestEncoding = &#x27;utf-8&#x27;,

    /**
     * A reference to the default function
     *
     * @private
     * @type {function}
     **/
    mDefaultController = null;

/**
 * Wrappes an object to a callable function
 *
 * @private
 * @param {object} aCallbackObject The object, which should be wrapped
 * @param {request} aRequest An nodejs request-object
 * @param {response} aResponse An nodejs response object
 * @param {object} aArgs Arguments, given by called url
 **/
function objectToCallbackWrapper(aCallbackObject, aRequest, aResponse, aArgs) {
    &#x27;use strict&#x27;;
    try {
        switch(aRequest.method.toLowerCase()) {
        case &#x27;get&#x27;:
            aCallbackObject.doGet(aRequest, aResponse, aArgs);
            break;
        case &#x27;post&#x27;:
            aCallbackObject.doPost(aRequest, aResponse, aArgs);
            break;
        case &#x27;put&#x27;:
            aCallbackObject.doPut(aRequest, aResponse, aArgs);
            break;
        case &#x27;head&#x27;:
            aCallbackObject.doHead(aRequest, aResponse, aArgs);
            break;
        case &#x27;delete&#x27;:
            aCallbackObject.doDelete(aRequest, aResponse, aArgs);
            break;
        }
    }
    catch (e) {
        if (typeof mDefaultController === &#x27;function&#x27;) {
            mDefaultController(aRequest, aResponse, aArgs);
        }
        else {
            aResponse.writeHead(404);
            aResponse.end();
        }
    }
}

/**
 * Deletes all routes
 *
 * @chainable
 * @method clearRoutes
 * @return {object} The instance itself
 */
function clearRoutes() {
    &#x27;use strict&#x27;;
    mRoutes = [];
    return EXPORTOBJECT;
}

/**
 * Sets the default route controller for all not routeable requests
 *
 * @chainable
 * @method setDefaultRoute
 * @param {function} aController
 * @return {object} The instance itself
 */
function setDefaultRoute(aController) {
    &#x27;use strict&#x27;;
    if (typeof aController === &#x27;function&#x27;) {
        mDefaultController = aController;
    }
    else {
        throw &#x27;$ROUTER.setDefaultRoute first param needs to be a function as controller, got &#x27; + (typeof aController);
    }
    return EXPORTOBJECT;
}

/**
 * Returns the default route controller
 *
 * @method getDefaultRoute
 * @return {function | null}
 */
function getDefaultRoute() {
    &#x27;use strict&#x27;;
    return mDefaultController;
}

/**
 * This function generates a route object from given path
 *
 * @private
 * @param {string} aPath
 * @param {bool} aSensetive
 * @return {object}
 * 
 * inspired by expressjs (https://github.com/visionmedia/express/blob/master/lib/utils.js) pathRegexp
 */
function pathToRoute(aPath, aSensetive) {
    &#x27;use strict&#x27;;
    var tmpObj = {path: aPath, keys: []};
    aPath = aPath
        .concat(&#x27;/?&#x27;)
        .replace(/\/\(/g, &#x27;(?:/&#x27;)
        .replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g, function(_, slash, format, key, capture, optional, star){
            tmpObj.keys.push({ name: key, optional: !! optional });
            slash = slash || &#x27;&#x27;;
            return &#x27;&#x27; +
                (optional ? &#x27;&#x27; : slash) +
                &#x27;(?:&#x27; +
                (optional ? slash : &#x27;&#x27;) +
                (format || &#x27;&#x27;) + (capture || (format &amp;&amp; &#x27;([^/.]+?)&#x27; || &#x27;([^/]+?)&#x27;)) + &#x27;)&#x27; +
                (optional || &#x27;&#x27;) +
                (star ? &#x27;(/*)?&#x27; : &#x27;&#x27;);
        })
        .replace(/([\/.])/g, &#x27;\\$1&#x27;)
        .replace(/\*/g, &#x27;(.*)&#x27;);
    tmpObj.regex = new RegExp(&#x27;^&#x27; + aPath + &#x27;$&#x27;, aSensetive ? &#x27;&#x27; : &#x27;i&#x27;);
    return tmpObj;
}

/**
 * Adds a route to the router with controller as first url param, action as second url param and callback as handle
 * for the request
 *
 * @method addRoute
 * @param {string} aPath
 * @param {function | object} aCallback
 * @param {bool} aCaseSensetive Optional, false by default
 * 
 */
function addRoute(aPath, aCallback, aCaseSensetive) {
    &#x27;use strict&#x27;;
    aCaseSensetive = aCaseSensetive || false;
    if (typeof aPath !== &#x27;string&#x27;) {
        throw &#x27;$ROUTER.addRoute first param needs to be a string, got &#x27; + (typeof aPath);
    }
    if (typeof aCallback !== &#x27;function&#x27; &amp;&amp; typeof aCallback !== &#x27;object&#x27;) {
        throw &#x27;$ROUTER.addRoute second param needs to be a function, got &#x27; + (typeof aPath);
    }
    aPath = (aPath[0] === &#x27;/&#x27;) ? aPath : &#x27;/&#x27; + aPath;

    var tmp = pathToRoute(aPath, aCaseSensetive);
    
    if (typeof aCallback === &#x27;object&#x27;) {
        tmp.callbackData = aCallback;
        tmp.callback = objectToCallbackWrapper.bind(null, tmp.callbackData);
    }
    else {
        tmp.callback = aCallback;
    }
    mRoutes.push(tmp);
    return EXPORTOBJECT;
}

/**
 * Returns the controller connected to a certain route. If the route wasn&#x27;t defined it returns &#x27;undefined&#x27;
 *
 * @method getRoute
 * @param {string} aPath
 * @return {object | null}
 */
function getRoute(aPath) {
    &#x27;use strict&#x27;;
    if (typeof aPath !== &#x27;string&#x27;) {throw &#x27;no string&#x27;; }
    aPath = (aPath[0] === &#x27;/&#x27;) ? aPath : &#x27;/&#x27; + aPath;
    for (var x in mRoutes) {
        if (aPath.match(mRoutes[x].regex) !== null) {
            return mRoutes[x];
        }
    }
    return null;
}

/**
 * Set the encoding for the request
 *
 * @method setEncoding
 * @param {string} aEncoding
 */
function setEncoding(aEncoding) {
    &#x27;use strict&#x27;;
    // TODO: test whether encoding is right
    mRequestEncoding = aEncoding || &#x27;utf-8&#x27;;
    return EXPORTOBJECT;
}

/**
 * Returns the current encoding for requests
 *
 * @method getEncoding
 * @return {string}
 */
function getEncoding() {
    &#x27;use strict&#x27;;
    return mRequestEncoding;
}


/**
 * This function is the routers core function. It gets the request from http or https server, and routes it to the
 * controller
 *
 * @method route
 * @param {request} aRequest An nodejs request
 * @param {response} aResponse An nodejs response
 */
function route(aRequest, aResponse) {
    &#x27;use strict&#x27;;
    var postData = &#x27;&#x27;;
    
    aRequest.setEncoding(mRequestEncoding);
    
    aRequest.on(&#x27;data&#x27;, function(chunk) {
        postData += chunk;
    });
    
    aRequest.on(&#x27;end&#x27;, function() {
        var urlParsed   = mUrl.parse(aRequest.url, true),
            path        = urlParsed.pathname,
            tmp, x;

        // region set GPC
        // parse post
        if (aRequest.headers[&#x27;content-type&#x27;] &amp;&amp; aRequest.headers[&#x27;content-type&#x27;].toLowerCase() === &#x27;application/json&#x27;) {
            try {
                aRequest.post = JSON.parse(postData);
            }
            catch(e) {
                aRequest.post = {};
            }
        }
        else {
            aRequest.post = mQuerystring.parse(postData);
        }

        // parse get
        aRequest.get = urlParsed.query;

        // parse cookies
        aRequest.cookie = {};
        var cookies = (aRequest.headers.cookie) ? aRequest.headers.cookie.split(&#x27;;&#x27;) : [];
        for (x in cookies) {
            if (typeof cookies[x] === &#x27;string&#x27;) {
                tmp = cookies[x].split(&#x27;=&#x27;);
                aRequest.cookie[tmp[0]] = tmp[1];
            }
        }
        // endregion
        
        // find matching route
        for (x in mRoutes) {
            if (typeof mRoutes[x] === &#x27;object&#x27;) {
                tmp = path.match(mRoutes[x].regex);
                if (tmp !== null) {
                    var args = {};
                    for (var y = 0; y &lt; mRoutes[x].keys.length; y++) {
                        args[mRoutes[x].keys[y].name] = tmp[y+1];
                    }

                    process.nextTick(function(aX, aArgs) {
                        mRoutes[aX].callback(aRequest, aResponse, aArgs);
                    }.bind(null, x, args));
                    return;
                }
            }
        }
        
        // if no route is defined, call default if exists
        if (typeof mDefaultController === &#x27;function&#x27;) {
            mDefaultController(aRequest, aResponse, path);
        }
        else {
            aResponse.writeHead(404);
            aResponse.end();
        }
    });
}

Object.defineProperty(EXPORTOBJECT, &#x27;route&#x27;, {
    value: route,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;addRoute&#x27;, {
    value: addRoute,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;getRoute&#x27;, {
    value: getRoute,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;setDefaultRoute&#x27;, {
    value: setDefaultRoute,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;getDefaultRoute&#x27;, {
    value: getDefaultRoute,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;setEncoding&#x27;, {
    value: setEncoding,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;getEncoding&#x27;, {
    value: getEncoding,
    writable: false
});
Object.defineProperty(EXPORTOBJECT, &#x27;clearRoutes&#x27;, {
    value: clearRoutes,
    writable: false
});

module.exports = EXPORTOBJECT;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
